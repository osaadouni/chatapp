<template>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-12">
                <div class="card card-default">
                    <div class="card-header">Chat Demo Component</div>

                    <div class="card-body">
                            
                        <chat-log :messages="messages"></chat-log>
                        <chat-composer @messagesent="addMessage"></chat-composer>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script>

let ChatLog      = require('./ChatLog.vue');
let ChatComposer = require('./ChatComposer.vue');

    export default {

        data() { 

            return { 

                messages: [
                    
                ]
            }

        }, 


        mounted() {
            console.log('[ChatDemo] mounted.')
        },

        created() { 
            console.log('[ChatDemo] created()...');
            this.getMessages();

            Echo.join('chatroom')
                .here((users) => { 
                    console.log('here..');
                    console.log(users);
                })
                .joining((user) => { 
                    console.log('joining...');
                    console.log(user);
                })
                .leaving((user) => { 
                    console.log('leaving...');
                    console.log(user);

                })
                .listen('MessagePosted', (e) => {
                    console.log('listening[MessagePosted]..');
                    console.log(e);

                });
        },

        components: {
            'chat-log': ChatLog, 
            'chat-composer': ChatComposer   
        }, 

        methods: { 
        
            addMessage(message) { 
                console.log('addMessage() called');

                console.log(message);

                // Add to existing messages
                this.messages.push(message);
                

                // presist to the database
                axios.post('/messages', message).then(response => { 
                        console.log(response);

                })
                .catch(error => { 
                    
                    console.log(error);
                });
            }, 

            getMessages() {
                axios.get('/messages').then(response => { 
                    console.log(response.data);
                    this.messages = response.data;
                })
                .catch(error => {
                    console.log(error);  
                });
            }
        }
    }
</script>
